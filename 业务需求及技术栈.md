# 股票交易记录管理平台 多用户版 需求文档

## 一、项目概述

开发一个多用户股票交易记录管理平台，满足以下核心需求：

- **用户隔离**：每个用户独立管理自己的股票及交易记录。
- **交易精准配对**：每笔卖出必须关联特定买入记录，支持部分卖出。
- **手动股价管理**：用户自行维护股票当前价格，无需对接外部API。
- **管理员控制**：只有管理员可以创建、删除用户，普通用户自行注册，但是只能在股票清单上，最多新增5条股票记录。管理员被标记"星球"的tag的用户不限制股票记录条数。
- **响应式设计**：完全兼容移动端和桌面端，提供一致的用户体验。

## 二、技术栈

### 前端技术栈

#### 核心框架
- **React**: 用于构建用户界面的JavaScript库
- **TypeScript**: JavaScript的超集，添加静态类型定义
- **Vite**: 现代前端构建工具，提供更快的开发体验
- **TanStack Router**: 类型安全的React路由解决方案
- **TanStack Query**: 数据获取和缓存管理库

### 状态管理
- **Zustand**: 轻量级状态管理库
- **React Hook Form**: 高性能表单处理库
- **Zod**: TypeScript优先的模式验证库

#### UI组件
- **Tailwind CSS**: 实用优先的CSS框架
- **Shadcn UI**: 基于Radix UI的可定制组件系统
  - Card
  - Dialog
  - Button
  - Input
  - Label
  - Badge
  - Table
  - Toast
- **Tabler Icons**: 现代化图标库
- **Recharts**: 基于React的图表库，用于数据可视化

### 网络请求
- **Axios**: 基于Promise的HTTP客户端

### 工具库
- **date-fns**: 现代JavaScript日期工具库
- **clsx & tailwind-merge**: CSS类名组合工具
- **js-cookie**: 简化Cookie处理的JavaScript API

### 后端服务
- **Supabase ：提供数据库、认证和存储服务

### 部署平台
Vercel

## 三、功能需求

### 1. 用户与权限模块

| 功能         | 说明                                                         |
| ------------ | ------------------------------------------------------------ |
| 管理员登录   | 支持邮箱+密码登录        |
| 用户管理     | 管理员可创建、编辑、删除用户账户                             |
| 用户分组     | 支持为用户添加标签，便于分组管理                             |
| 登出         | 清除用户会话                                                 |
| 权限控制     | 根据用户角色控制功能访问权限，非管理员用户侧边栏不显示管理员功能模块 |

- 使用 Supabase Auth 实现身份验证。
- 前端集成 shadcn/ui 的表单和认证组件。
- 普通用户自行注册，但是只能在股票清单上，最多新增5条股票记录。
- 管理员被标记"星球"的tag的用户不限制股票记录条数。

### 2. 股票清单页（主页）

| 功能             | 说明                                                         |
| ---------------- | ------------------------------------------------------------ |
| 股票列表展示     | 显示股票名称、代码、当前价格、浮动盈亏、持仓数量、持仓金额、最后更新时间 |
| 手动更新股价     | 每个股票右侧提供"更新价格"按钮，弹出对话框输入新价格         |
| 编辑股票信息     | 支持编辑股票代码和名称                                       |
| 新增股票         | 用户可手动添加新股票（代码需唯一性校验）                     |
| 删除股票         | 用户可删除不再需要的股票（删除前需确认，同时删除相关交易记录）|
| 数据排序         | 支持按名称、盈亏比例、持仓金额排序                           |
| 响应式布局       | 自适应布局，确保在各种设备上的良好显示                       |

### 2. 交易明细页

| 功能             | 说明                                                         |
| ---------------- | ------------------------------------------------------------ |
| 交易记录展示     | 按时间倒序显示所有交易记录                                   |
| 买入记录         | 显示买入时间、数量、价格、剩余可卖数量、手续费、本笔浮盈、买入理由 |
| 卖出记录         | 显示在对应买入记录下方，包含卖出时间、数量、价格、手续费、盈亏、卖出理由 |
| 状态标识         | 未卖出（绿色）、部分卖出（橙色）、已卖出（灰色）             |
| 盈亏颜色显示     | 盈利（正值）显示红色，亏损（负值）显示绿色，符合股票市场习惯 |
| 本笔浮盈         | 显示每笔买入记录未卖出部分的浮动盈亏和百分比                 |
| 买入操作         | 支持新增买入记录，包含数量、价格、日期、手续费、标签、备注   |
| 卖出操作         | 点击未完全卖出的买入记录进行卖出，自动填充可卖数量和手续费   |
| 编辑功能         | 支持编辑任意交易记录的数量、价格、日期、手续费、标签、备注   |
| 删除功能         | 支持删除交易记录，买入记录有关联卖出时需先删除卖出记录       |
| 手续费自动计算   | 基于交易金额自动计算手续费（费率0.03%，低于5000元最少5元）   |
| 交易理由标签     | 预设常用标签（如：止盈、止损、调仓等），支持多选             |
| 按钮图标统一     | 编辑按钮（铅笔图标）、删除按钮（垃圾桶图标）保持视觉统一     |

### 3. 数据存储与同步

| 功能             | 说明                                                         |
| ---------------- | ------------------------------------------------------------ |
| 按理由标签统计   | 显示每个标签的使用次数、平均持仓时间、总盈亏、胜率           |
| 交易明细联动     | 点击标签可跳转至筛选后的交易列表                             |
| 数据可视化       | 柱状图对比不同标签的盈利表现，时间轴趋势图展示策略有效性变化 |
| 数据导出         | 支持导出分析结果为CSV或图表                                  |
| 响应式图表       | 图表组件自适应屏幕尺寸，在移动端优化显示方式                 |

### 4. 计算功能

| 功能             | 说明                                                         |
| ---------------- | ------------------------------------------------------------ |
| 持仓数量         | 计算每只股票的当前持仓数量（未卖出的总数）                   |
| 持仓金额         | 持仓数量 × 当前价格                                          |
| 浮动盈亏         | (当前价格 - 加权平均成本价) × 持仓数量 - 总交易费用         |
| 盈亏百分比       | 浮动盈亏 ÷ 总成本 × 100%                                    |
| 加权平均成本     | ∑(买入价格 × 数量 + 交易费用) ÷ 总持仓数量                  |
| 手续费计算       | 交易金额 × 0.0003，低于5000元时最少收取5元                   |
| 交易盈亏         | 卖出金额 - 买入成本 - 买入手续费 - 卖出手续费               |
| 本笔浮盈         | (当前价格 - 买入价格) × 剩余数量 - 按比例分摊的买入手续费    |

### 5. 用户体验

| 功能             | 说明                                                         |
| ---------------- | ------------------------------------------------------------ |
| 操作反馈         | 所有操作都有Toast提示                                        |
| 表单验证         | 实时验证输入数据的有效性                                     |
| 确认对话框       | 重要操作需要确认                                             |
| 排序提示         | 可排序列显示排序图标                                         |
| 智能删除保护     | 删除买入记录时检查关联卖出记录，确保数据一致性               |
| 自动计算提示     | 手续费输入框显示计算规则提示                                 |
| 图标化操作       | 使用直观图标提升操作识别度（编辑、删除、添加等）             |
| 实时计算反馈     | 输入价格和数量时实时计算并显示手续费                         |

## 四、数据结构

### 1. 用户（User）
```typescript
interface User {
  id: string;
  auth_id: string;
  name: string;
  email: string;
  role: 'admin' | 'user';
  tags: string[];
  created_at: string;
  updated_at: string;
}
```

### 2. 股票（Stock）
```typescript
interface Stock {
  id: string;
  user_id: string;
  stock_code: string;
  stock_name: string;
  current_price: number;
  updated_at: string;
}
```

### 3. 交易记录（Transaction）
```typescript
interface Transaction {
  id: string;
  user_id: string;
  stock_id: string;
  type: 'buy' | 'sell';
  quantity: number;
  price: number;
  fee: number;
  timestamp: string;
  parent_buy_id?: string;
  remaining?: number;
  batch_id?: string;
  buy_reason?: {
    tags: string[];
    note: string;
  };
  sell_reason?: {
    tags: string[];
    note: string;
  };
}
```

## 五、开发规范

### 1. 代码组织
- 使用TypeScript强类型
- 组件化开发
- 统一的错误处理
- 完善的注释

### 2. UI规范
- 使用Shadcn UI组件库
- 响应式设计
- 统一的颜色系统
- 一致的交互模式

### 3. 数据处理

- 数据验证
- 错误处理
- 状态管理

## 六、后续优化方向

1. 添加更多分析功能
2. 支持数据导入导出
3. 添加更多图表展示
4. 优化移动端体验
5. 添加批量操作功能
6. 支持多主题切换
7. 添加键盘快捷操作
8. 优化性能和加载速度

## 七、功能更新记录

### v1.1.0 - 2024年12月 交易明细页增强

#### 🔧 手续费自动计算系统
- **智能手续费计算**：实现基于交易金额的自动手续费计算
  - 费率：0.03% (万分之三)
  - 最低收费：交易金额低于5000元时，最少收取5元手续费
  - 实时计算：输入价格和数量时自动更新手续费

- **全流程集成**：
  - 买入对话框：自动计算并可手动调整手续费
  - 卖出对话框：自动计算并可手动调整手续费  
  - 编辑对话框：修改价格数量时重新计算手续费
  - 显示优化：交易记录中显示手续费信息

#### 🗑️ 交易记录删除功能
- **智能删除控制**：
  - 买入记录保护：存在关联卖出记录时阻止删除，提示先删除卖出记录
  - 卖出记录：可直接删除，自动更新相关买入记录的剩余数量
  - 确认机制：删除前弹出确认对话框，防止误操作

- **用户体验优化**：
  - 删除按钮：添加垃圾桶图标，视觉上易于识别
  - 错误处理：完善的错误提示和网络异常处理
  - 数据同步：删除后自动刷新交易记录列表

#### 🎨 界面优化升级
- **图标统一化**：
  - 编辑按钮：添加铅笔图标（IconPencil）
  - 删除按钮：添加垃圾桶图标（IconTrash）
  - 样式统一：所有按钮使用一致的 `variant="outline"` 和 `size="sm"`

- **计算精度提升**：
  - 盈亏计算：完整考虑买入和卖出的手续费
  - 浮盈计算：按比例分摊买入手续费到剩余持仓
  - 显示优化：卖出记录中显示手续费信息

#### 📊 数据完整性保障
- **关联性检查**：删除操作前检查数据关联关系
- **一致性维护**：确保买入卖出记录的数据一致性
- **错误预防**：多重验证防止数据异常

#### 🔄 技术债务清理
- **代码优化**：统一错误处理和状态管理
- **类型安全**：完善TypeScript类型定义
- **用户反馈**：所有操作都有明确的成功/失败提示

### 下一阶段规划
- 批量操作功能（批量删除、批量编辑）
- 数据导入导出优化
- 移动端交互体验优化
- 更多统计分析功能

# 开发步骤：
根据您的股票交易记录管理平台需求文档，下一步应该进行项目初始化和基础架构搭建。以下是建议的行动方向：

1. **项目初始化**：
   - 创建React项目（使用Next.js框架）
   - 配置Tailwind CSS和shadcn/ui组件库
   - 设置项目文件结构

2. **Supabase配置**：
   - 创建Supabase项目
   - 根据数据库设计创建表结构
   - 设置行级安全策略(RLS)
   - 配置身份验证系统

3. **基础架构搭建**：
   - 实现认证流程（管理员登录）
   - 创建布局组件（响应式导航栏）
   - 设置路由结构

4. **核心功能模块规划**：
   - 用户管理模块
   - 股票清单页
   - 交易明细页
   - 复盘分析页

5. **原型设计**：
   - 创建主要页面的线框图或原型
   - 确定响应式设计的断点和布局

---

**备注：**  
本需求文档为多用户股票交易记录管理平台的完整版本，适用于React + shadcn/ui + Supabase + Vercel技术栈，重点突出数据隔离、交易配对、手动股价管理、响应式设计与管理员用户管理等核心功能，便于后续开发与维护。

